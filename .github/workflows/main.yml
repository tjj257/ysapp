name: Sync Upstream Repositories

on:
  schedule:
    # 每天 0,6,12,18 点运行 (UTC 时间)
    - cron: '0 6,12,18,0 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  sync-fongmi:
    name: Sync FongMi/Release (fongmi branch)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        ref: fongmi  # 切换到 fongmi 分支
        
    - name: Add upstream remote (FongMi)
      run: |
        git remote add upstream https://github.com/FongMi/Release.git
        git fetch upstream fongmi --depth=1
        
    - name: Check and update sync branch if needed
      run: |
        # 获取当前分支的上游仓库和分支
        current_upstream_branch=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")
        
        if [ -n "$current_upstream_branch" ]; then
          # 提取上游仓库名称
          current_upstream=$(echo "$current_upstream_branch" | cut -d'/' -f1)
          
          # 检查是否与要同步的上游仓库一致
          if [ "$current_upstream" != "upstream" ]; then
            echo "当前分支的上游仓库($current_upstream)与要同步的上游仓库(upstream)不一致"
            echo "正在更新上游仓库设置..."
            
            # 获取当前分支的远程名称和分支名
            current_branch=$(git rev-parse --abbrev-ref HEAD)
            current_remote=$(echo "$current_upstream_branch" | cut -d'/' -f1)
            
            # 删除旧的上游设置
            git branch --unset-upstream
            
            # 设置新的上游仓库
            git branch -u upstream/fongmi $current_branch
            
            echo "已更新上游仓库设置: $current_branch -> upstream/fongmi"
          else
            echo "当前分支的上游仓库设置正确，无需更改"
          fi
        else
          echo "当前分支未设置上游仓库，正在设置..."
          current_branch=$(git rev-parse --abbrev-ref HEAD)
          git branch -u upstream/fongmi $current_branch
          echo "已设置上游仓库: $current_branch -> upstream/fongmi"
        fi
        
    - name: Merge upstream changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git merge upstream/fongmi --allow-unrelated-histories --no-edit || true
        
    - name: Push changes
      run: git push origin fongmi

  sync-lystv:
    name: Sync lystv/fmapp (ok branch)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        ref: ok  # 切换到 ok 分支
        
    - name: Add upstream remote (lystv)
      run: |
        git remote add upstream https://github.com/lystv/fmapp.git
        git fetch upstream ok --depth=1
        
    - name: Check and update sync branch if needed
      run: |
        # 获取当前分支的上游仓库和分支
        current_upstream_branch=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")
        
        if [ -n "$current_upstream_branch" ]; then
          # 提取上游仓库名称
          current_upstream=$(echo "$current_upstream_branch" | cut -d'/' -f1)
          
          # 检查是否与要同步的上游仓库一致
          if [ "$current_upstream" != "upstream" ]; then
            echo "当前分支的上游仓库($current_upstream)与要同步的上游仓库(upstream)不一致"
            echo "正在更新上游仓库设置..."
            
            # 获取当前分支的远程名称和分支名
            current_branch=$(git rev-parse --abbrev-ref HEAD)
            current_remote=$(echo "$current_upstream_branch" | cut -d'/' -f1)
            
            # 删除旧的上游设置
            git branch --unset-upstream
            
            # 设置新的上游仓库
            git branch -u upstream/ok $current_branch
            
            echo "已更新上游仓库设置: $current_branch -> upstream/ok"
          else
            echo "当前分支的上游仓库设置正确，无需更改"
          fi
        else
          echo "当前分支未设置上游仓库，正在设置..."
          current_branch=$(git rev-parse --abbrev-ref HEAD)
          git branch -u upstream/ok $current_branch
          echo "已设置上游仓库: $current_branch -> upstream/ok"
        fi
        
    - name: Merge upstream changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git merge upstream/ok --allow-unrelated-histories --no-edit || true
        
    - name: Push changes
      run: git push origin ok
